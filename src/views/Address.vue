<template>
    <h1 class="text-2xl font-semibold">Address</h1>
    <div class="mt-5 max-w-7xl mx-auto">
        <p class="mb-5 text-sm text-gray-500">Asterisk(*) is required fields.</p>
        <div class="divide-y divide-gray-900/10">
            <dl class="space-y-6 divide-y divide-gray-900/10">
            <Disclosure as="div" v-for="(address, index) in addresses" :key="index" :class="index > 0 ? 'pt-6' : ''" v-slot="{ open }">
                <div>
                    <DisclosureButton class="flex w-full items-start justify-between text-left text-gray-900">
                        <span class="text-base font-semibold leading-7">{{ address.type }}</span>
                        <span class="ml-6 flex h-7 items-center">
                        <PlusIcon v-if="!open" class="h-6 w-6" aria-hidden="true" />
                        <MinusIcon v-else class="h-6 w-6" aria-hidden="true" />
                        </span>
                    </DisclosureButton>
                </div>
                <DisclosurePanel as="div" class="mt-2 pr-12">
                    <Form :submit="onAddressesSave(index)" :submitLoading="submitLoading" :form="compAddressForm(index)" @onchange-form="updateAddressesForm(index, $event)"></Form>
                </DisclosurePanel>
            </Disclosure>
            </dl>
        </div>
    </div>
</template>

<script setup lang="ts">
    import { ref, computed, onMounted } from 'vue';
    import { Disclosure, DisclosureButton, DisclosurePanel } from '@headlessui/vue';
    import { MinusIcon, PlusIcon } from '@heroicons/vue/outline';
    import Form from '../components/form/Form.vue';
    import services from '../services';

    const submitLoading = ref(false);
    const addresses = ref([
        {
            type: 'Billing',
            addressForm: {
                country: {
                    label: 'Country*',
                    value: '',
                    type: 'select',
                },
                stateProvince: {
                    label: 'State / Province*',
                    value: '',
                    type: 'text',
                },
                city: {
                    label: 'City*',
                    value: '',
                    type: 'text',
                },
                zipcode: {
                    label: 'Zipcode*',
                    value: '',
                    type: 'text',
                },
                address: {
                    label: 'Address*',
                    value: '',
                    type: 'text',
                },
            }
        },
        {
            type: 'Postal',
            addressForm: {
                country: {
                    label: 'Country*',
                    value: '',
                    type: 'select',
                },
                stateProvince: {
                    label: 'State / Province*',
                    value: '',
                    type: 'text',
                },
                city: {
                    label: 'City*',
                    value: '',
                    type: 'text',
                },
                zipcode: {
                    label: 'Zipcode*',
                    value: '',
                    type: 'text',
                },
                address: {
                    label: 'Address*',
                    value: '',
                    type: 'text',
                },
            }
        }
    ]) as any;

    onMounted(() => {
        showForm();
    });

    const showForm = async() => {
        await services.showAddress();
    };

    const onAddressesSave = (index: number) => async () => {
        submitLoading.value = true;
        addresses.value[index].addressForm['errors'] = {};
        // let addressFormData = formTraits.setFormData(addresses.value[index].addressForm) as any;
        // addressFormData.type = addresses.value[index].type;
        // await accountService.updateAddress(getMe.value.id, addressFormData)
        // .then(() => {
        //     submitLoading.value = false;
        //     toast.success('Successfully Save!', {
        //         timeout: 2000
        //     });
        // })
        // .catch((error) => {
        //     submitLoading.value = false;
        //     addresses.value[index].addressForm['errors'] = error;
        //     toast.error('Something went wrong!', {
        //         timeout: 2000
        //     });
        // });
    };

    const compAddressForm =  computed(() => (index: number) => addresses.value[index].addressForm);
</script>